<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SquareGolf Connector</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>SquareGolf</h2>
                <div class="app-subtitle">Unofficial Connector</div>
            </div>

            <div class="nav-menu">
                <button class="nav-button active" data-screen="device">
                    <span class="material-icons">bluetooth</span>
                    Device
                </button>
                <button class="nav-button" data-screen="shotMonitor">
                    <span class="material-icons">assessment</span>
                    Shot Monitor
                </button>
                <button class="nav-button" data-screen="gspro">
                    <span class="material-icons">computer</span>
                    GSPro
                </button>
                <button class="nav-button" data-screen="camera">
                    <span class="material-icons">videocam</span>
                    Camera
                </button>
                <button class="nav-button" data-screen="alignment">
                    <span class="material-icons">tune</span>
                    Alignment
                </button>
                <button class="nav-button" data-screen="settings">
                    <span class="material-icons">settings</span>
                    Settings
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Global Status Bar -->
            <div class="global-status-bar compact" id="statusBar">
                <h1 class="page-title" id="pageTitle">Device Connection</h1>
                <div class="status-item" id="statusWebSocket">
                    <span class="status-icon material-icons">cloud</span>
                    <span class="status-label">Server</span>
                    <span class="status-dot"></span>
                </div>
                <div class="status-item" id="statusDevice">
                    <span class="status-icon material-icons">bluetooth</span>
                    <span class="status-label">Device</span>
                    <span class="status-dot"></span>
                </div>
                <div class="status-item" id="statusGSPro">
                    <span class="status-icon material-icons">computer</span>
                    <span class="status-label">GSPro</span>
                    <span class="status-dot"></span>
                </div>
                <div class="status-item" id="statusBallReady">
                    <span class="status-icon material-icons">sports_golf</span>
                    <span class="status-label">Ball Ready</span>
                    <span class="status-dot"></span>
                </div>
            </div>

            <!-- Device Screen -->
            <div class="screen active" id="deviceScreen">
                <div class="card">
                    <div class="card-header">
                        <h3>Connection Status</h3>
                    </div>
                    <div class="card-content">
                        <div class="status-row">
                            <span class="status-label">Status:</span>
                            <span class="status-value" id="deviceStatus">Disconnected</span>
                        </div>
                        <div class="error-message" id="deviceError" style="display: none;"></div>
                        
                        <div class="control-buttons">
                            <input type="text" id="deviceNameInput" placeholder="Device name (leave empty to scan)" class="input-field">
                            <p class="helper-text">💡 Leave empty to automatically scan and connect to any available SquareGolf device, or enter a specific device name to connect to that device.</p>
                            <div class="button-group">
                                <button class="btn btn-primary" id="connectBtn">Connect</button>
                                <button class="btn btn-secondary" id="disconnectBtn" disabled>Disconnect</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Information -->
                <div class="card" id="deviceInfoCard" style="display: none;">
                    <div class="card-header">
                        <h3>Device Information</h3>
                    </div>
                    <div class="card-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Device Name:</span>
                                <span class="info-value" id="connectedDeviceName">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Battery Level:</span>
                                <span class="info-value" id="batteryLevel">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Firmware:</span>
                                <span class="info-value" id="firmwareVersion">-</span>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Metrics -->
                <div class="card" id="metricsCard" style="display: none;">
                    <div class="card-header">
                        <h3>Last Shot Metrics</h3>
                    </div>
                    <div class="card-content">
                        <div class="metrics-tabs">
                            <button class="tab-button active" data-tab="ball">Ball</button>
                            <button class="tab-button" data-tab="club">Club</button>
                        </div>
                        <div class="metrics-content">
                            <div class="metrics-tab active" id="ballMetrics"></div>
                            <div class="metrics-tab" id="clubMetrics"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shot Monitor Screen -->
            <div class="screen" id="shotMonitorScreen">
                <!-- Ball Position Visualization -->
                <div class="card">
                        <div class="card-header">
                            <h3>Ball Position</h3>
                        </div>
                        <div class="card-content">
                            <div class="ball-position-container">
                                <svg class="ball-position-svg" viewBox="0 0 300 400" id="ballPositionSvg">
                                    <!-- Grid lines -->
                                    <defs>
                                        <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                                            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#2a3f5f" stroke-width="0.5"/>
                                        </pattern>
                                    </defs>
                                    <rect width="300" height="400" fill="url(#grid)" />

                                    <!-- Axes -->
                                    <line x1="150" y1="0" x2="150" y2="400" stroke="#64748b" stroke-width="1" stroke-dasharray="5,5"/>
                                    <line x1="0" y1="200" x2="300" y2="200" stroke="#64748b" stroke-width="1" stroke-dasharray="5,5"/>

                                    <!-- Target zone (ideal position) -->
                                    <circle cx="150" cy="200" r="30" fill="#22c55e" fill-opacity="0.1" stroke="#22c55e" stroke-width="2"/>

                                    <!-- Ball position dot -->
                                    <circle id="ballDot" cx="150" cy="200" r="8" fill="#ef4444" stroke="#fff" stroke-width="2" style="display: none;"/>

                                    <!-- Distance labels -->
                                    <text x="155" y="50" fill="#64748b" font-size="10">-150mm</text>
                                    <text x="155" y="350" fill="#64748b" font-size="10">+150mm</text>
                                    <text x="10" y="205" fill="#64748b" font-size="10">-150mm</text>
                                    <text x="250" y="205" fill="#64748b" font-size="10">+150mm</text>
                                </svg>

                                <!-- Position Coordinates Display -->
                                <div class="position-coords" id="positionCoords">
                                    <div class="coord-item">
                                        <span class="coord-label">X:</span>
                                        <span class="coord-value" id="coordX">--</span>
                                    </div>
                                    <div class="coord-item">
                                        <span class="coord-label">Y:</span>
                                        <span class="coord-value" id="coordY">--</span>
                                    </div>
                                    <div class="coord-item">
                                        <span class="coord-label">Z:</span>
                                        <span class="coord-value" id="coordZ">--</span>
                                    </div>
                                </div>

                                <!-- Distance from center indicator -->
                                <div class="distance-indicator" id="distanceIndicator" style="display: none;">
                                    <span class="material-icons">center_focus_strong</span>
                                    <span class="distance-label">Distance from center:</span>
                                    <span class="distance-value" id="distanceValue">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Last Shot Metrics -->
                <div class="card" id="monitorCurrentShotCard">
                    <div class="card-header">
                        <h3>Last Shot Metrics</h3>
                    </div>
                    <div class="card-content">
                        <!-- Placeholder when no shot data -->
                        <div id="monitorShotPlaceholder" class="shot-placeholder">
                            <span class="material-icons shot-placeholder-icon">sports_golf</span>
                            <p class="shot-placeholder-title">Waiting for shot data...</p>
                            <p class="shot-placeholder-subtitle">Hit a shot to see ball and club metrics</p>
                        </div>

                        <!-- Actual metrics (hidden by default) -->
                        <div id="monitorShotData" style="display: none;">
                            <div class="monitor-metrics-tabs">
                                <button class="tab-button active" data-tab="monitorBall">Ball Data</button>
                                <button class="tab-button" data-tab="monitorClub">Club Data</button>
                            </div>
                            <div class="monitor-metrics-content">
                                <div class="metrics-tab active" id="monitorBallMetrics"></div>
                                <div class="metrics-tab" id="monitorClubMetrics"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- GSPro Screen -->
            <div class="screen" id="gsproScreen">
                <div class="card">
                    <div class="card-header">
                        <h3>Connection Status</h3>
                    </div>
                    <div class="card-content">
                        <div class="status-row">
                            <span class="status-label">Status:</span>
                            <span class="status-value" id="gsproStatus">Disconnected</span>
                        </div>
                        <div class="error-message" id="gsproError" style="display: none;"></div>
                        
                        <div class="button-group">
                            <button class="btn btn-primary" id="gsproConnectBtn">Connect to GSPro</button>
                            <button class="btn btn-secondary" id="gsproDisconnectBtn" disabled>Disconnect</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Troubleshooting</h3>
                    </div>
                    <div class="card-content">
                        <div class="troubleshooting-info">
                            <p><strong>If the launch monitor will not go into ball detection mode:</strong></p>
                            <ol>
                                <li>Try changing the club in GSPro</li>
                                <li>If still not working, restart GSPconnect:
                                    <ul>
                                        <li>Go to Settings → System → Reset GSPro Connect</li>
                                        <li>This app will automatically reconnect</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Screen -->
            <div class="screen" id="cameraScreen">
                <div class="card">
                    <div class="card-header">
                        <h3>Camera Configuration</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="cameraURL">Camera URL:</label>
                            <input type="text" id="cameraURL" class="input-field" value="http://localhost:5000" placeholder="http://localhost:5000">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="cameraEnabled">
                                Enable camera integration
                            </label>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" id="cameraSaveBtn">Save Settings</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>How It Works</h3>
                    </div>
                    <div class="card-content">
                        <div class="camera-info">
                            <p>The camera integration automatically:</p>
                            <ul>
                                <li><strong>Arms the camera</strong> when the ball is detected and ready</li>
                                <li><strong>Triggers recording</strong> when shot metrics are received</li>
                                <li><strong>Cancels recording</strong> if the ball is removed before a shot</li>
                            </ul>
                            <p class="info-note">⚠️ Make sure your camera server is running and accessible at the configured URL.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alignment Screen -->
            <div class="screen" id="alignmentScreen">
                <!-- Alignment Display Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>Aim Direction</h3>
                    </div>
                    <div class="card-content alignment-display">
                        <!-- Inline Error Message -->
                        <div class="error-message" id="alignmentError" style="display: none;">
                            <p class="error-text"></p>
                            <button class="btn btn-primary btn-sm" id="retryAlignmentBtn">Retry Alignment</button>
                        </div>
                        <!-- Visual Compass -->
                        <div class="compass-container">
                            <svg class="compass-svg" viewBox="0 0 200 200" id="compassSvg">
                                <!-- Background circle -->
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#2a3f5f" stroke-width="2"/>

                                <!-- Target zone (±2 degrees) -->
                                <path id="targetZone" d="" fill="#22c55e" fill-opacity="0.2" stroke="#22c55e" stroke-width="2"/>

                                <!-- Degree markers -->
                                <line x1="100" y1="20" x2="100" y2="30" stroke="#64748b" stroke-width="2"/> <!-- 0° -->
                                <line x1="170" y1="100" x2="180" y2="100" stroke="#64748b" stroke-width="1"/> <!-- 90° -->
                                <line x1="100" y1="170" x2="100" y2="180" stroke="#64748b" stroke-width="1"/> <!-- 180° -->
                                <line x1="20" y1="100" x2="30" y2="100" stroke="#64748b" stroke-width="1"/> <!-- -90° -->

                                <!-- Center target -->
                                <circle cx="100" cy="100" r="5" fill="#64748b"/>

                                <!-- Aim pointer (rotates based on angle) -->
                                <g id="aimPointer" transform="rotate(0 100 100)">
                                    <line x1="100" y1="100" x2="100" y2="30" stroke="#3b82f6" stroke-width="4" stroke-linecap="round"/>
                                    <circle cx="100" cy="30" r="8" fill="#3b82f6"/>
                                </g>
                            </svg>
                        </div>

                        <!-- Numeric Display -->
                        <div class="alignment-numbers">
                            <div class="alignment-angle" id="alignmentAngle">0.0°</div>
                            <div class="alignment-direction" id="alignmentDirection">Aimed straight</div>
                        </div>

                        <!-- Aligned Status Indicator -->
                        <div class="aligned-status" id="alignedStatus">
                            <span class="aligned-icon">⚪</span>
                            <span class="aligned-text">Waiting for data...</span>
                        </div>

                        <!-- Handedness Toggle -->
                        <div class="handedness-toggle">
                            <button class="handedness-btn" id="leftHandedBtn">
                                <span class="material-icons">chevron_left</span>
                            </button>
                            <span class="handedness-label" id="handednessLabel">RIGHT</span>
                            <button class="handedness-btn" id="rightHandedBtn">
                                <span class="material-icons">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Instructions Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>How to Use</h3>
                    </div>
                    <div class="card-content">
                        <div class="instructions">
                            <ul>
                                <li>Alignment starts automatically when you open this tab</li>
                                <li>Point the device at your target</li>
                                <li>Green circle appears when aligned (within ±2°)</li>
                                <li>Aim arrow shows current direction</li>
                                <li>Alignment stops when you leave this tab</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div class="screen" id="settingsScreen">
                <div class="card">
                    <div class="card-header">
                        <h3>Device Settings</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="settingsDeviceName">Preferred Device Name:</label>
                            <div class="input-group">
                                <input type="text" id="settingsDeviceName" class="input-field" placeholder="Device Name">
                                <button class="btn btn-secondary" id="forgetDeviceBtn">Forget</button>
                            </div>
                            <p class="helper-text">Save a specific device name to always connect to the same device. Click "Forget" to clear and scan for any device.</p>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="settingsAutoConnect">
                                Connect automatically on start
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Spin Detection Mode:</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="spinMode" value="standard">
                                    <div>
                                        <strong>Standard (Unmarked Balls)</strong>
                                        <p class="helper-text">Use with regular golf balls. Provides estimated spin measurements. Lower CPU usage.</p>
                                    </div>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="spinMode" value="advanced" checked>
                                    <div>
                                        <strong>Advanced (Marked Balls)</strong>
                                        <p class="helper-text">Use with specially marked/dotted golf balls for accurate spin data through camera tracking.</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>GSPro Settings</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="gsproAutoConnect">
                                Connect to GSPro automatically
                            </label>
                            <p class="helper-text">When enabled, automatically connects to GSPro when the device connects.</p>
                        </div>
                        <div class="form-group">
                            <label for="gsproIP">GSPro IP Address:</label>
                            <input type="text" id="gsproIP" class="input-field" value="127.0.0.1">
                        </div>
                        <div class="form-group">
                            <label for="gsproPort">GSPro Port:</label>
                            <input type="number" id="gsproPort" class="input-field" value="921">
                        </div>
                        <p class="helper-text">These settings rarely need to be changed. Default is localhost (127.0.0.1) on port 921.</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>About</h3>
                    </div>
                    <div class="card-content">
                        <p class="helper-text">
                            <strong>SquareGolf Connector</strong> is an unofficial connector for SquareGolf launch monitors.
                            <br><a href="https://github.com/byates/squaregolf-connector" target="_blank" style="color: #3b82f6;">View Documentation on GitHub</a>
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Connecting...</div>
    </div>

    <!-- Toast notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/app.js"></script>
</body>
</html>
